#include <esp_common.h>
#include <espconn.h>
#include <server.h>

#include "debug.h"
#include "mdns.h"


struct espconn user_udp_espconn;
extern bool ready;
extern bool pairing;
extern char myUsername[18];

char mdns[] = {
      0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x14, 0x48, 0x4b, 0x5f,       //HK_@0
      0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, //>myUserName@16*17
      0x05, 0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x00, 0x00, 0x01, 0x80, 0x01, 0x00, 0x00, 0x00, 0x78, 0x00, 0x04, //@33
      0x00, 0x00, 0x00, 0x00, //>IP address @50*4
      
      0x09, 0x5f, 0x73, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x73, 0x07, 0x5f, 0x64, 0x6e, 0x73, 0x2d,  //_services@54
      0x73, 0x64, 0x04, 0x5f, 0x75, 0x64, 0x70, 0xc0, 0x21, 0x00, 0x0c, 0x00, 0x01, 0x00, 0x00, 0x11,  //@70
      0x94, 0x00, 0x0c, 0x04, 0x5f, 0x68, 0x61, 0x70, 0x04, 0x5f, 0x74, 0x63, 0x70, 0xc0, 0x21,        //@86
      
      0xc0, 0x59, 0x00, 0x0c, 0x00, 0x01, 0x00, 0x00, 0x11, 0x94, 0x00,                                //_hap@101
      0x23, 0x20,             //>anl+3@112*1,  >anl@113*1
      0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e, 0x6f, 0x70,  //>accname@114*anl
      0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7a, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46,
      0xc0, 0x59,             //<@146
      
      0xc0, 0x71, 0x00, 0x21, 0x80, 0x01, 0x00, 0x00, 0x00, 0x78, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00,  //SRV@anl+116
      0x02, 0x95, 0xc0, 0x0c, //>HAP tcp-port 661@anl+132*2
      
      0xc0, 0x71, 0x00, 0x10, 0x80, 0x01, 0x00, 0x00, 0x11, 0x94, 0x00,                                    //TXT@anl+136
      0x59, 0x23,             //>anl+57@anl+147*1,  >anl+3@anl+148*1
      0x6d, 0x64, 0x3d,                                                                                    //id=@anl+149
      0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e, 0x6f, 0x70,      //>accname@anl+152*anl
      0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7a, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46,
      0x06, 0x70, 0x76, 0x3d, 0x31, 0x2e, 0x30, 0x14, 0x69, 0x64, 0x3d,                                    //@2anl+152
      0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30,//>myUserName@2anl+163*17
      0x04, 0x63, 0x23, 0x3d, 0x31, 0x04, 0x73, 0x23, 0x3d, 0x31, 0x04, 0x66, 0x66, 0x3d, 0x30, 0x04,      //@2anl+180
      0x63, 0x69, 0x3d, 0x31, 0x04, 0x73, 0x66, 0x3d,                                                      //@2anl+196
      0x31                                                                                                 //>status@2anl+204*1
 };

 /******************************************************************************
      * FunctionName : user_udp_sent_cb
      * Description  : udp sent successfully
      * Parameters  : arg -- Additional argument to pass to the callback function
      * Returns      : none
 *******************************************************************************/
LOCAL void ICACHE_FLASH_ATTR user_udp_sent(void *arg)
{  
    #ifdef DEBUG0
    os_printf("pairing %d, heap %d, system time=%d\n", pairing, system_get_free_heap_size(),system_get_time()/1000);
    #endif
}

void send_mdns(void *arg) {
    struct ip_info ipconfig;
    const char udp_remote_ip[4] = {224, 0, 0, 251};  
    char *accname = arg;
    int anl = ANLMAX;
    
    user_udp_espconn.type = ESPCONN_UDP;
    user_udp_espconn.proto.udp = (esp_udp *)zalloc(sizeof(esp_udp));
    user_udp_espconn.proto.udp->local_port = 5353;  // set mdns  port

    espconn_regist_sentcb(&user_udp_espconn, user_udp_sent); // register a udp packet sent callback
    espconn_create(&user_udp_espconn);   // create udp socket
    
    if (strlen(accname)<ANLMAX) anl=strlen(accname);
    unsigned int mdns_len = 2*anl+205;

    memcpy( 16 + mdns, myUsername,17);
//  memcpy( 50+mdns,&ipconfig.ip.addr,4);
    mdns[112] = anl + 3;
    mdns[113] = anl;
    memcpy(114 + mdns, accname, anl);
    memcpy(114 + mdns + anl, 114 + ANLMAX + mdns, 205 + 2 * ANLMAX - anl - 114); //transfer other bytes forward
    mdns[147 + anl] = anl + 57;
    mdns[148 + anl] = anl + 3;
    memcpy(152 + mdns + anl, accname, anl);
    memcpy(152 + mdns + 2 * anl, 152 + ANLMAX + anl + mdns, 205 + ANLMAX - anl - 152); //transfer other bytes forward
    memcpy(163 + mdns + 2 * anl, myUsername, 17);
//    mdns[204+2*anl]=0x30+pairing;

    while (!ready) {
        // FIXME: 100ms? 10 ticks!
        vTaskDelay(10); //100ms
    }

    server_init(0x0295); // iana HAP port 661

    while (1) {
        wifi_get_ip_info(STATION_IF, &ipconfig);
        memcpy(50 + mdns, &ipconfig.ip.addr, 4);
        mdns[204 + 2 * anl] = 0x30 + pairing;
        
        // ESP8266 udp remote IP need to be set everytime we call espconn_sent
        memcpy(user_udp_espconn.proto.udp->remote_ip, udp_remote_ip, 4); 
        
        // ESP8266 udp remote port need to be set everytime we call espconn_sent
        user_udp_espconn.proto.udp->remote_port = 5353;
        espconn_send(&user_udp_espconn, mdns, mdns_len);

        // FIXME: 3 s? 300 ticks!
        vTaskDelay(300); //3 sec
    }
}
